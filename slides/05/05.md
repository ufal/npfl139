title: NPFL139, Lecture 5
class: title, langtech, cc-by-sa
# Rainbow II, Distributional RL

## Milan Straka

### March 19, 2025

---
section: $N$-step
class: section
# Multi-step DQN

---
# Rainbow DQN Extensions
## Multi-step DQN

Instead of Q-learning, we use $n$-step variant of Q-learning, which estimates
return as
$$âˆ‘_{i=1}^n Î³^{i-1} R_i + Î³^n \max_{a'} Q(s', a'; â†’Î¸Ì„).$$

~~~
This changes the off-policy algorithm to on-policy (because the â€œinnerâ€ actions
are sampled from the behaviour distribution, but should follow the target distribution);
however, it is not discussed in any way by the authors.

---
section: NoisyNets
class: section
# Noisy Nets

---
# Rainbow DQN Extensions

## Noisy Nets

Noisy Nets are neural networks whose weights and biases are perturbed by
a parametric function of a noise.

~~~
The parameters $â†’Î¸$ of a regular neural network are in Noisy nets represented as
$$â†’Î¸ â‰ˆ â†’Î¼ + â†’Ïƒ âŠ™ â†’Îµ,$$
where $â†’Îµ$ is zero-mean noise with fixed statistics. We therefore learn the
parameters $(â†’Î¼, â†’Ïƒ)$.

~~~
A fully connected layer $â†’y = â†’w â†’x + â†’b$ with parameters $(â†’w, â†’b)$ is
represented in the following way in Noisy nets:
$$â†’y = (â†’Î¼_w + â†’Ïƒ_w âŠ™ â†’Îµ_w) â†’x + (â†’Î¼_b + â†’Ïƒ_b âŠ™ â†’Îµ_b).$$

~~~
Each $Ïƒ_{i,j}$ is initialized to $\frac{Ïƒ_0}{\sqrt{n}}$, where $n$ is the number
of input neurons of the layer in question, and $Ïƒ_0$ is a hyperparameter; commonly 0.5.

---
# Rainbow DQN Extensions

## Noisy Nets

The noise $Îµ$ can be for example independent Gaussian noise. However, for
performance reasons, factorized Gaussian noise is used to generate a matrix of
noise. If $Îµ_{i, j}$ is noise corresponding to a layer with $n$ inputs and $m$
outputs, we generate independent noise $Îµ_i$ for input neurons, independent
noise $Îµ_j$ for output neurons, and set
$$Îµ_{i,j} = f(Îµ_i) f(Îµ_j)~~~\textrm{for}~~~f(x) = \operatorname{sign}(x) \sqrt{|x|}.$$
~~~
The authors generate noise samples for every batch, sharing the noise for all
batch instances (consequently, during loss computation, online and target
network use independent noise).

~~~
### Deep Q Networks
When training a DQN, $Îµ$-greedy is no longer used (all policies are greedy), and
all fully connected layers are parametrized as noisy nets in both the current
and target network (i.e., networks produce samples from the distribution of
returns, and greedy actions still explore).

---
# Rainbow DQN Extensions

## Noisy Nets

![w=50%,h=center](dqn_noisynets_results.svgz)

![w=65%,h=center](dqn_noisynets_curves.svgz)

---
# Rainbow DQN Extensions

## Noisy Nets

![w=100%](dqn_noisynets_noise_study.svgz)

The $Î£Ì„$ is the mean-absolute of the noise weights $â†’Ïƒ_w$, i.e.,
$Î£Ì„ = \frac{1}{\textit{layer size}} \|â†’Ïƒ_w\|_1$.

---
section: DistributionalRL
class: section
# Distributional RL

---
# Rainbow DQN Extensions

## Distributional RL

Instead of an expected return $Q(s, a)$, we could estimate the distribution of
expected returns $Z(s, a)$ â€“ the _value distribution_.

~~~
The authors define the distributional Bellman operator $ğ“£^Ï€$ as:
$$ğ“£^Ï€ Z(s, a) â‰ R(s, a) + Î³ Z(S', A')~~~\textrm{for}~~~S'âˆ¼p(s, a), A'âˆ¼Ï€(S').$$

~~~
The authors of the paper prove similar properties of the distributional Bellman
operator compared to the regular Bellman operator, mainly being a contraction
under a suitable metric
~~~
(for Wasserstein metric $W_p$, the authors define
$WÌ„_p(Z_1, Z_2)â‰\sup_{s, a} W_p\big(Z_1(s, a), Z_2(s, a)\big)$ and prove that
$ğ“£^Ï€$ is a Î³-contraction in $WÌ„_p$).

---
style: .katex-display { margin: .8em 0 }
class: dbend
# Wasserstein Metric

For two probability distributions $Î¼, Î½$, Wasserstein metric $W_p$ is defined as
$$W_p(Î¼, Î½) â‰ \inf_{Î³âˆˆÎ“(Î¼,Î½)} \big(ğ”¼_{(x, y)âˆ¼Î³} \|x-y\|^d\big)^{1/p},$$
~~~
where $Î“(Î¼,Î½)$ is a set of all _couplings_, each being a joint probability
distribution whose marginals are $Î¼$ and $Î½$, respectively.
~~~
A possible intuition is the optimal transport of probability mass from $Î¼$ to
$Î½$.

~~~
For distributions over reals with CDFs $F, G$, the optimal transport has an
analytic solution:

![w=27.5%,f=right](wasserstein-1.svgz)

$$W_p(Î¼, Î½) = \bigg(âˆ«\nolimits_0^1 |F^{-1}(q) - G^{-1}(q)|^p \d q\bigg)^{1/p},$$
where $F^{-1}$ and $G^{-1}$ are _quantile functions_, i.e., inverse CDFs.

~~~
For $p=1$, the 1-Wasserstein metric correspond to area â€œbetweenâ€ F and G, and
in that case we can compute it also as $W_1(Î¼, Î½) = âˆ«\nolimits_x \big|F(x)- G(x)\big| \d x.$

---
# Rainbow DQN Extensions

## Distributional RL

The distribution of returns is modeled as a discrete distribution parametrized
by the number of atoms $N âˆˆ â„•$ and by $V_\textrm{MIN}, V_\textrm{MAX} âˆˆ â„$.
Support of the distribution are atoms
$$\{z_i â‰ V_\textrm{MIN} + i Î”z : 0 â‰¤ i < N\}\textrm{~~~for~}Î”z â‰ \frac{V_\textrm{MAX} - V_\textrm{MIN}}{N-1}.$$

~~~
The atom probabilities are predicted using a $\softmax$ distribution as
$$Z_{â†’Î¸}(s, a) = \left\{z_i\textrm{ with probability }p_i = \frac{e^{f_i(s, a; â†’Î¸)}}{âˆ‘_j e^{f_j(s, a; â†’Î¸)}}\right\}.$$

---
# Rainbow DQN Extensions

## Distributional RL

![w=30%,f=right](dqn_distributional_operator.svgz)

After the Bellman update, the support of the distribution $R(s, a) + Î³Z(s', a')$
is not the same as the original support. We therefore project it to the original
support by proportionally mapping each atom of the Bellman update to immediate
neighbors in the original support.

~~~
$$Î¦\big(R(s, a) + Î³Z(s', a')\big)_i â‰
  âˆ‘_{j=1}^N \left[ 1 - \frac{\left|[r + Î³z_j]_{V_\textrm{MIN}}^{V_\textrm{MAX}}-z_i\right|}{Î”z} \right]_0^1 p_j(s', a').$$

~~~
The network is trained to minimize the Kullbeck-Leibler divergence between the
current distribution and the (mapped) distribution of the one-step update
$$D_\textrm{KL}\Big(Î¦\big(R + Î³Z_{â†’Î¸Ì„}\big(s', \argmax_{a'} ğ”¼Z_{â†’Î¸Ì„}(s', a')\big)\big) \Big\| Z_{â†’Î¸}\big(s, a\big)\Big).$$

---
# Rainbow DQN Extensions

## Distributional RL

![w=50%,h=center](dqn_distributional_algorithm.svgz)


---
# Rainbow DQN Extensions

## Distributional RL

![w=40%,h=center](dqn_distributional_results.svgz)

![w=40%,h=center](dqn_distributional_example_distribution.svgz)

---
# Rainbow DQN Extensions

## Distributional RL

![w=100%](dqn_distributional_example_distributions.svgz)

---
# Rainbow DQN Extensions

## Distributional RL

![w=100%](dqn_distributional_atoms_ablation.svgz)
